<html>
<head>

</head>
<body>

  <script type="text/javascript">
  var maxDataPoint = 0;
  var graphDataNames = [];
  var graphData = [];
  var dataObject = null;
  
  function storeData(obj, columnToDisplay) {
    for (var i=0; i < 5; i++) {
      var regex = /\/apis\/ajaxsearch\/(.*)/;
      var relaURL = obj.value.items[i].Key.match(regex)[1];
      var pageViews = obj.value.items[i].Cell[columnToDisplay].Primary;


      pageViews = parseFloat(pageViews.replace(',',''));
      if(parseFloat(pageViews) > maxDataPoint) {
        maxDataPoint = pageViews;
      }
      graphDataNames.unshift(relaURL);
      console.log(pageViews);
      graphData.push(pageViews);
    }
  }

  function setMaxPoint() {
    var numDivisions = 0;
    while(maxDataPoint > 100) {
      maxDataPoint = maxDataPoint / 10;
      numDivisions++;
    }
    maxDataPoint = Math.floor((maxDataPoint+1));
    while(numDivisions > 0) {
      maxDataPoint = maxDataPoint * (10);
      numDivisions--;
    }
  }

  function setDataPoints() {
    for (var i=0; i < graphData.length; i++) {
      graphData[i] = Math.floor(100*graphData[i] / maxDataPoint);
    }
    return(graphData);
  }

  function topcontentCallback(obj) {
    var html = '<select id="graphData" onchange="changeGraphData(this.value);">';
    html += '<option value=0>Page Views</option>';
    html += '<option value=1>Unique Page Views</option>';
    html += '</select>';
    html += '<div id="popularPosts">';
    html += '</div>';
    document.getElementsByTagName('body')[0].innerHTML = html;
    dataObject = obj;
    
    insertGraph(0);
  }
  
  function insertGraph(dataColumnToDisplay) {
    storeData(dataObject, dataColumnToDisplay);
    setMaxPoint();
    graphData = setDataPoints();
    var title = 'AJAX+Search+Pages+';
    title += dataColumnToDisplay == 0 ? '(Page+Views+Today)' : '(Unique+Page+Views+Today)';
    
    
    sortArrays();

    
    var graph = document.createElement('img');
    graph.src = "http://www.google.com/chart?cht=bhs&chs=500x160&chd=t:"+graphData.join(',')+"&chco=3072F3&chls=1,3.75,1&chxt=x,y&chxl=1:|"+graphDataNames.join('|')+"&chxr=0,0,"+maxDataPoint+"&chtt="+title+"&chbh=20,2&chg=20,5,5,4";
    
    console.log(graphData);
    console.log(graphDataNames);
    console.log(maxDataPoint);
    console.log(graph.src);
    
    
    document.getElementById("popularPosts").appendChild(graph);
  }
  
  function sortArrays() {
    var changed = true;
// simple bubble sort
    while(changed) {
      changed = false;
      for (var i=0; i < graphData.length; i++) {
        if(i != graphData.length-1) {
          if(graphData[i] < graphData[i+1]) {
            var tempData = graphData[i];
            graphData[i] = graphData[i+1];
            graphData[i+1] = tempData;
            
            var tempData = graphDataNames[i];
            graphDataNames[i] = graphDataNames[i+1];
            graphDataNames[i+1] = tempData;
            
            changed = true;
          }
        }
      }
    }
  }
  
  
  function resetData() {
    maxDataPoint = 0;
    graphDataNames = [];
    graphData = [];
    document.getElementById("popularPosts").innerHTML = '';
  }
  
  
  function changeGraphData(clickValue) {
    resetData();
    insertGraph(clickValue)
  }
  

  </script>

  <script type="text/javascript" src="http://pipes.yahoo.com/pipes/pipe.run?_id=641d127f63df1a29127d53385132782d&_render=json&_callback=topcontentCallback"></script>
</body>
</html>



